<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema SaaS - Restaurante Pesqueiro (MVP)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="pedidos.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar / Menu Principal (MVP) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/api/placeholder/150/80" alt="Logo Restaurante Pesqueiro" class="logo">
                <h2>Recanto Rancho do Peixe</h2>
            </div>
            
            <div class="user-info">
                <img src="/api/placeholder/50/50" alt="Foto Usuário" class="user-avatar">
                <div class="user-details">
                    <span class="user-name">Paulo Palazi</span>
                    <span class="user-role">Administrador</span>
                </div>
            </div>
            
            <nav class="main-menu">
                <ul>
                    <!-- 1. Dashboard -->
                    <li class="menu-item active">
                        <a href="#" data-page="dashboard">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    
                    <!-- 2. Pedidos -->
                    <li class="menu-item has-submenu">
                        <a href="#pedidos">
                            <i class="fas fa-utensils"></i>
                            <span>Pedidos</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li><a href="#" data-page="pedidos">Novos Pedidos</a></li>
                            <li><a href="#" data-page="pedidos-andamento">Pedidos em Andamento</a></li>
                            <li><a href="#" data-page="historico-pedidos">Histórico de Pedidos</a></li>
                        </ul>
                    </li>
                    
                    <!-- 3. Cozinha -->
                    <li class="menu-item has-submenu">
                        <a href="#cozinha">
                            <i class="fas fa-fire"></i>
                            <span>Cozinha</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li><a href="#" data-page="painel-cozinha">Painel da Cozinha</a></li>
                            <li><a href="#" data-page="pedidos-prontos">Pedidos Prontos</a></li>
                        </ul>
                    </li>
                    
                    <!-- 4. Mesas -->
                    <li class="menu-item has-submenu">
                        <a href="#mesas-layout">
                            <i class="fas fa-chair"></i>
                            <span>Mesas</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li><a href="#" data-page="mapa-mesas">Mapa de Mesas</a></li>
                            <li><a href="#" data-page="reservas">Reservas</a></li>
                        </ul>
                    </li>
                    
                    <!-- 5. Cardápio -->
                    <li class="menu-item has-submenu">
                        <a href="#cardapio">
                            <i class="fas fa-book-open"></i>
                            <span>Cardápio</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li><a href="#" data-page="gerenciar-itens">Gerenciar Itens</a></li>
                            <li><a href="#" data-page="categorias">Categorias</a></li>
                        </ul>
                    </li>
                    
                    <!-- 6. Configurações -->
                    <li class="menu-item has-submenu">
                        <a href="#configuracoes">
                            <i class="fas fa-cog"></i>
                            <span>Configurações</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li><a href="#" data-page="perfil-restaurante">Perfil do Restaurante</a></li>
                            <li><a href="#" data-page="usuarios-permissoes">Usuários</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <a href="#suporte">
                    <i class="fas fa-question-circle"></i>
                    <span>Suporte</span>
                </a>
                <a href="#sair">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </a>
            </div>
        </aside>
        
        <!-- Conteúdo Principal -->
        <main class="main-content">
            <header class="top-header">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Pesquisar...">
                </div>
                
                <div class="header-actions">
                    <div class="notifications">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="action-btn" id="novo-pedido-btn" data-page="pedidos">
                            <i class="fas fa-plus"></i>
                            <span>Novo Pedido</span>
                        </button>
                    </div>
                </div>
            </header>
            
            <div class="content-area" id="content-area">
                <!-- O conteúdo será carregado dinamicamente aqui -->
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <div class="breadcrumb">
                        <span>Home</span> / <span>Dashboard</span>
                    </div>
                </div>
                
                <!-- Cards de Resumo -->
                <div class="summary-cards">
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-chair"></i>
                        </div>
                        <div class="card-info">
                            <h3>Mesas</h3>
                            <div class="card-numbers">
                                <span class="number">12</span>
                                <span class="status">/ 20 ocupadas</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="card-info">
                            <h3>Pedidos</h3>
                            <div class="card-numbers">
                                <span class="number">28</span>
                                <span class="status">+14% hoje</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="card-info">
                            <h3>Faturamento</h3>
                            <div class="card-numbers">
                                <span class="number">R$ 4.250</span>
                                <span class="status">+5% hoje</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seção Mapa de Mesas -->
                <section class="mesas-section">
                    <div class="section-header">
                        <h2>Mapa de Mesas</h2>
                        <div class="section-actions">
                            <button class="btn" data-page="mapa-mesas">Ver todas</button>
                        </div>
                    </div>
                    
                    <div class="mesas-grid">
                        <div class="mesa livre">
                            <span class="mesa-number">01</span>
                            <span class="mesa-status">Livre</span>
                        </div>
                        
                        <div class="mesa ocupada">
                            <span class="mesa-number">02</span>
                            <span class="mesa-status">Ocupada</span>
                            <span class="mesa-info">2 pessoas</span>
                        </div>
                        
                        <div class="mesa ocupada">
                            <span class="mesa-number">03</span>
                            <span class="mesa-status">Ocupada</span>
                            <span class="mesa-info">4 pessoas</span>
                        </div>
                        
                        <div class="mesa reservada">
                            <span class="mesa-number">04</span>
                            <span class="mesa-status">Reservada</span>
                            <span class="mesa-info">19:00</span>
                        </div>
                        
                        <div class="mesa livre">
                            <span class="mesa-number">05</span>
                            <span class="mesa-status">Livre</span>
                        </div>
                        
                        <div class="mesa livre">
                            <span class="mesa-number">06</span>
                            <span class="mesa-status">Livre</span>
                        </div>
                    </div>
                </section>
                
                <!-- Seção Pedidos Recentes -->
                <section class="pedidos-section">
                    <div class="section-header">
                        <h2>Pedidos Recentes</h2>
                        <div class="section-actions">
                            <button class="btn" data-page="pedidos-andamento">Ver todos</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pedido #</th>
                                    <th>Mesa</th>
                                    <th>Itens</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>#1254</td>
                                    <td>03</td>
                                    <td>Peixe Frito, Porção de Batatas, Refrigerante</td>
                                    <td>R$ 98,50</td>
                                    <td><span class="status em-preparo">Em Preparo</span></td>
                                    <td>
                                        <button class="action-btn"><i class="fas fa-eye"></i></button>
                                        <button class="action-btn"><i class="fas fa-edit"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>#1253</td>
                                    <td>02</td>
                                    <td>Camarão ao Alho, Arroz, Salada, Cerveja</td>
                                    <td>R$ 145,00</td>
                                    <td><span class="status servido">Servido</span></td>
                                    <td>
                                        <button class="action-btn"><i class="fas fa-eye"></i></button>
                                        <button class="action-btn"><i class="fas fa-edit"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>#1252</td>
                                    <td>01</td>
                                    <td>Tilápia Grelhada, Arroz, Feijão</td>
                                    <td>R$ 78,00</td>
                                    <td><span class="status fechado">Fechado</span></td>
                                    <td>
                                        <button class="action-btn"><i class="fas fa-eye"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Indicador de carregamento -->
    <div id="loading-indicator" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Área para notificações do sistema -->
    <div class="notifications-container" aria-live="polite"></div>
    
    <script src="script.js"></script>
    
    <!-- Script para autenticação -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se o usuário está autenticado
            const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
            
            if (!token) {
                // Redirecionar para login se não estiver autenticado
                window.location.href = 'login.html';
                return;
            }
            
            // Preencher informações do usuário no sidebar
            const userData = JSON.parse(localStorage.getItem('userData') || sessionStorage.getItem('userData') || '{}');
            if (userData) {
                const userNameElement = document.querySelector('.user-name');
                const userRoleElement = document.querySelector('.user-role');
                
                if (userNameElement) userNameElement.textContent = userData.nome || 'Usuário';
                if (userRoleElement) userRoleElement.textContent = userData.perfil || 'Padrão';
            }
            
            // Configurar botão de logout
            const logoutLink = document.querySelector('a[href="#sair"]');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Mostrar indicador de carregamento se existir
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) loadingIndicator.style.display = 'flex';
                    
                    // Chamar API de logout
                    fetch('http://localhost:3000/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(() => {
                        // Limpar armazenamento
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userData');
                        localStorage.removeItem('tenantId');
                        
                        sessionStorage.removeItem('accessToken');
                        sessionStorage.removeItem('refreshToken');
                        sessionStorage.removeItem('userData');
                        sessionStorage.removeItem('tenantId');
                        
                        // Redirecionar para login
                        window.location.href = 'login.html';
                    })
                    .catch(error => {
                        console.error('Erro ao fazer logout:', error);
                        // Mesmo com erro, fazer logout local
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                    })
                    .finally(() => {
                        // Esconder indicador de carregamento
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                    });
                });
            }
            
            // Interceptar requisições para adicionar token de autenticação
            const originalFetch = window.fetch;
            window.fetch = async function(url, options = {}) {
                // Se não for requisição de login ou refresh token
                if (!url.includes('/api/auth/login') && !url.includes('/api/auth/refresh-token')) {
                    // Configurar headers se não existirem
                    options.headers = options.headers || {};
                    
                    // Adicionar token de autorização
                    const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
                    if (token) {
                        options.headers['Authorization'] = `Bearer ${token}`;
                    }
                }
                
                try {
                    // Fazer a requisição
                    const response = await originalFetch(url, options);
                    
                    // Se a resposta for 401 (Não Autorizado) ou 403 (Proibido)
                    if (response.status === 401 || response.status === 403) {
                        // Tentar refresh token
                        const refreshToken = localStorage.getItem('refreshToken') || sessionStorage.getItem('refreshToken');
                        
                        if (refreshToken) {
                            try {
                                const refreshResponse = await originalFetch('http://localhost:3000/api/auth/refresh-token', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ refreshToken })
                                });
                                
                                const refreshData = await refreshResponse.json();
                                
                                if (refreshData.accessToken) {
                                    // Atualizar token
                                    if (localStorage.getItem('accessToken')) {
                                        localStorage.setItem('accessToken', refreshData.accessToken);
                                    } else {
                                        sessionStorage.setItem('accessToken', refreshData.accessToken);
                                    }
                                    
                                    // Retentar a requisição original com o novo token
                                    options.headers['Authorization'] = `Bearer ${refreshData.accessToken}`;
                                    return originalFetch(url, options);
                                } else {
                                    // Falha no refresh token, fazer logout
                                    localStorage.clear();
                                    sessionStorage.clear();
                                    window.location.href = 'login.html';
                                    throw new Error('Sessão expirada. Por favor, faça login novamente.');
                                }
                            } catch (refreshError) {
                                // Erro no refresh token, fazer logout
                                localStorage.clear();
                                sessionStorage.clear();
                                window.location.href = 'login.html';
                                throw new Error('Sessão expirada. Por favor, faça login novamente.');
                            }
                        } else {
                            // Não há refresh token, fazer logout
                            localStorage.clear();
                            sessionStorage.clear();
                            window.location.href = 'login.html';
                            throw new Error('Sessão expirada. Por favor, faça login novamente.');
                        }
                    }
                    
                    return response;
                } catch (error) {
                    console.error('Erro na requisição:', error);
                    throw error;
                }
            };
        });
    </script>
</body>
</html>